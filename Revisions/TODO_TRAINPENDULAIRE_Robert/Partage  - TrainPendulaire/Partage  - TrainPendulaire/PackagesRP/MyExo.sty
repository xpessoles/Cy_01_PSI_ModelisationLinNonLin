% !TEX encoding = latin1
\NeedsTeXFormat{LaTeX2e}[1999/01/01]
\ProvidesPackage{MyExo}[2010/01/12]

\RequirePackage{fancyvrb}
\RequirePackage{afterpage}
\RequirePackage{zref,zref-user}
\RequirePackage{framed}
\RequirePackage{relsize}
\RequirePackage{needspace}


\RequirePackage[table,usenames,dvipsnames]{xcolor}
%\RequirePackage[usenames,dvipsnames]{xcolor}
%\RequirePackage{tikz}
\definecolor{light-gray}{gray}{0.9}
%\colorlet{light-gray}{white!20!black}
\colorlet{exoColor}{white!70!BlueViolet}

%%%%%%%%%% Macros \partie \qst \sq et \ssq pour les questions des exos %%%%%%%%%%%%%%
\zref@newprop{NomDuLien}{}
\zref@addprop{main}{NomDuLien}
\newcommand\LaBeL[2]{\zref@setcurrent{NomDuLien}{#1}\zlabel{#2}}
\newcommand\LaBeLNum[2]{\zref@setcurrent{NomDuLien}{#1}\zlabel{#2}#1}

\newcommand{\Zref}{\zref[NomDuLien]}

\newcounter{numexo} % exercicedecours
\setcounter{numexo}{1}
\newcounter{numexercice}
\setcounter{numexercice}{1}



\newenvironment{barregauche}{%
% ajout pour une marge droite augmentée
\par
\addtolength{\hsize}{-1cm}%
% fin de l'ajout
\renewcommand\FrameCommand{%
\hspace*{-10pt}%
\vrule width 3pt
\hspace{10pt}%
}%
\MakeFramed{%
\addtolength{\hsize}{-\width}%
\FrameRestore
}
}%
{\endMakeFramed}

\newcounter{numcor}
\setcounter{numcor}{1}

\newcounter{partie}[numexo]
\newcounter{subpartie}[partie]
\newcounter{subsubpartie}[subpartie]
%\newcounter{qst}[partie]
\newcounter{qst}[numexo]
\newcounter{sq}[qst]
\newcounter{ssq}[sq]
\newcounter{sssq}[ssq]
\renewcommand{\thepartie}{\Alph{partie}}
\renewcommand{\thesubpartie}{\arabic{subpartie}}
\renewcommand{\thesubsubpartie}{\alph{subpartie}}
\renewcommand{\theqst}{\arabic{qst}}
\renewcommand{\thesq}{\alph{sq}}
\renewcommand{\thessq}{\roman{ssq}}

\newcounter{annexe}[numexo]
\setcounter{annexe}{0}
\newcommand{\annexe}[2][A-\theannexe]{
\refstepcounter{annexe}\LaBeL{A-\theannexe}{#1}
\paragraph*{A-\theannexe. #2}\label{annexe:A-#2}~\par
}

\newcounter{DocReponse}[numexo]
\setcounter{DocReponse}{0}
\newcommand{\DocReponse}[2][DR-\theDocReponse]{
\refstepcounter{DocReponse}\LaBeL{DR-\theDocReponse}{#1}
\paragraph*{DR-\theDocReponse. #2}~\par
}

\newcommand*{\partie}{\@ifstar\partieNN\partieN}
\newcommand{\partieN}[1]{\refstepcounter{partie}\setcounter{sq}{0}\setcounter{ssq}{0}\vspace{-.5em}%\setcounter{qst}{0}
\paragraph*{\thepartie. #1}~\par}
\newcommand{\partieNN}[1]{\setcounter{sq}{0}\setcounter{ssq}{0}%\setcounter{qst}{0}
\paragraph*{ #1}~\par}

\newcommand*{\subpartie}{\@ifstar\subpartieNN\subpartieN}
\newcommand{\subpartieN}[1]{\refstepcounter{subpartie}\setcounter{ssq}{0}\setcounter{sq}{0}\vspace{-.5em}
\subparagraph*{ \thepartie.\thesubpartie. #1}~\par}
\newcommand{\subpartieNN}[1]{\refstepcounter{subpartie}\setcounter{sq}{0}\setcounter{ssq}{0}%
\subparagraph*{ #1}~\par}


\newcommand{\subsubpartie}[1]{\refstepcounter{subsubpartie}\setcounter{sssq}{0}\setcounter{ssq}{0}%
\subparagraph*{\textbf{--- #1}}~\par}

\newcommand{\DecalePar}[1][0.5em]{\begin{minipage}{#1}\end{minipage}}


\newcommand{\qst}[1][Q\theqst]{\par\setcounter{sq}{0}\setcounter{ssq}{0}%
\refstepcounter{qst}\LaBeL{Q\theqst}{#1}\noindent{\textbf{Q\theqst. }}}

\newcommand{\qstsq}{\par\DecalePar[1em]\setcounter{sq}{0}\setcounter{ssq}{0}\refstepcounter{qst}\refstepcounter{sq}\noindent
{\textbf{Q\theqst\thesq. }}}

\newcommand{\sq}[1][]{\par\DecalePar[1em] \setcounter{ssq}{0}\refstepcounter{sq}\noindent
{\textbf{Q\theqst\thesq. } #1}}%\subparagraph*

\newcommand{\ssq}[1][]{\par\refstepcounter{ssq}
 {\textnormal{\textit{(\thessq)}. \textsc{#1} ---}}}%\subparagraph*

\newcommand\ecaption[1]
           {\addcontentsline{xmp}{exercice}{#1}}

\newcommand\listofexercices
               {\chapter{Liste des exercices}\@starttoc{xmp}}
 \newcommand\l@exercice[2]
    {\par\noindent#1,~\textit{#2}\par}   

%==========

\newcounter{numexorel} % numerotation relative entre deux corrigés
\setcounter{numexorel}{0}
\newcounter{debutexo}
\newcounter{finexo}

%==============
\newcommand\az{}
%\DeclareCaptionFont{az}{\az}
%\renewcommand\az{\scriptsize\color{red}}

\def\TypeExo{Exercice}
\def\LabelExo{exo:Exo\thenumexo}
\def\OrigineExo{ }
\def\TitreExo{ }

\def\TypeCor{Cor.}

\newcommand{\NoExo}[1]{#1}

\makeatletter
\define@key{ExoCat}{name}{\def\TypeExo{#1}} %
\define@key{ExoCat}{title}[]{\def\TitreExo{#1}} %
\define@key{ExoCat}{label}[exo:\thenumexo]{\def\LabelExo{#1}} %
\define@key{ExoCat}{origin}[]{\def\OrigineExo{#1}} %


\newcommand\killienc{}
\count@128
\@whilenum\count@<\@cclvi\do{%
   \edef\killienc{\killienc\catcode\the\count@=12}%
   \advance\count@\@ne}
%
\makeatother

\newenvironment{Exo}[1][]{%
\setkeys{ExoCat}{#1}
\ecaption{n°~\thenumexo - \TitreExo,\qquad ~\textit{\OrigineExo}\dotfill }
\noindent\colorbox{exoColor}{
\begin{minipage}[t]{\linewidth}
\textbf{\TypeExo~\thenumexo~- \TitreExo}\par 
{\small \itshape \OrigineExo}
\hfill
%\end{minipage}
%\begin{minipage}[t]{0.2\linewidth}
\small \itshape Corrig\'e page~\pageref{exo:Cor\thenumexo}
\end{minipage}\par%
}
\setcounter{partie}{0}%
\setcounter{qst}{0}%
\label{exo:Exo\thenumexo}%
\LaBeL{\TitreExo}{Exo\thenumexo}
\LaBeL{\TitreExo}{\LabelExo}
%\begin{barregauche}
%\setcounter{idGnuplot}{\thenumexo000}
}
{\stepcounter{numexo}\stepcounter{numexorel}~\par
%\end{barregauche}
}%

\newcommand{\RepriseExo}[1]
{
\noindent{\textbf{Exercice déplacé- \zref[NomDuLien]{#1}}}\par %
Reprendre l'exercice page~\zpageref{#1}  
\textbf{\zref[NomDuLien]{#1}}\par~\par
%\stepcounter{numexo}\stepcounter{numexorel}
}

\newcommand{\Qu}[1]{
\textbf{\TypeExo~\thenumexo~- }\label{exo:Exo\thenumexo}%
\setcounter{partie}{0}%
\setcounter{qst}{0}%
#1
\stepcounter{numexo}\stepcounter{numexorel}
}

\newcommand{\Qcor}[1]{
\killienc
\VerbatimEnvironment
\begin{VerbatimOut}{EXO/\jobname/EXO\thenumexo.cor} #1
\end{VerbatimOut}
}

\newenvironment{Cor}{%
\killienc
\VerbatimEnvironment
\begin{VerbatimOut}{EXO/\jobname/EXO\thenumexo.cor}}
{\end{VerbatimOut}
}




\newcommand{\EcrireCorrections}{
\setcounter{debutexo}{\thenumexo}
\addtocounter{debutexo}{-\thenumexorel}
\setcounter{finexo}{\thenumexo}
\addtocounter{finexo}{-1}
%\afterpage{\clearpage}
\foreach \nn in {\thedebutexo,...,\thefinexo}{
\noindent\begin{minipage}{0.8\textwidth}
\textbf{\TypeCor~\nn : \zref[NomDuLien]{Exo\nn}}
\end{minipage}
\begin{minipage}{0.2\textwidth}
 \itshape Sujet page~\pageref{exo:Exo\nn} \label{exo:Cor\nn}
\end{minipage}
%\color{purple}
\smaller
\setcounter{idGnuplot}{\nn000}
\addtocounter{idGnuplot}{500}
\setcounter{numexercice}{\nn}
\setcounter{partie}{0}
\setcounter{qst}{0}
%idgnuplot = \theidGnuplot

\input{EXO/\jobname/EXO\nn.cor}
\FloatBarrier
\Needspace*{0.1\textheight}
%~\par
\hrule
~\\[0.5em]
}
\afterpage{\clearpage}
\setcounter{numexorel}{0}
}


\newcommand{\MotsClefs}[2]{
\foreach \mc in {#2}{
%\index{#1!\mc}
\index{\mc!#1}
}
}



\newcommand{\Acompleter}[2][10]{
\foreach \nn in {1,2,...,#1}{
~ \dotfill ~ \par
}
}
